<!DOCTYPE html>
<html>
<head>
  <title>Realtime Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>

<body>
<div class="app">

  <header>
    <h3>Home</h3>
    <small id="myCode"></small>
  </header>

  <button onclick="newChat()">New Chat</button>

  <div id="chatList"></div>

</div>

<script>
/* ---------- FIREBASE ---------- */
firebase.initializeApp({
  apiKey: "AIzaSyAI5nA49KkR5VsPn3QpjWOdM0lv2nEQu3U",
  authDomain: "private-chat-app-2986d.firebaseapp.com",
  projectId: "private-chat-app-2986d"
});
var db = firebase.firestore();

/* ---------- SIMPLE USER CODE ---------- */
let myCode = localStorage.getItem("code");
if (!myCode) {
  myCode = "U-" + Math.random().toString(36).substr(2,5);
  localStorage.setItem("code", myCode);
}
document.getElementById("myCode").innerText = "Your code: " + myCode;

/* ---------- LOAD CHAT LIST ---------- */
db.collection("chats")
  .where("users", "array-contains", myCode)
  .onSnapshot(snap => {
    chatList.innerHTML = "";
    snap.forEach(doc => {
      const data = doc.data();
      const other = data.users.find(u => u !== myCode);

      const div = document.createElement("div");
      div.className = "chat";
      div.innerText = other + " : " + (data.last || "");
      div.onclick = () => {
        location.href = "chat.html?id=" + doc.id;
      };

      chatList.appendChild(div);
    });
  });

/* ---------- NEW CHAT ---------- */
function newChat() {
  const other = prompt("Enter other code");
  if (!other) return;

  const chatId = [myCode, other].sort().join("__");

  db.collection("chats").doc(chatId).set({
    users: [myCode, other],
    last: "",
    time: Date.now()
  });

  location.href = "chat.html?id=" + chatId;
}
</script>
</body>
</html>
